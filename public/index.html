<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translation App - Clean Version</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8fafc;
            color: #1f2937;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .header p {
            color: #6b7280;
            font-size: 16px;
        }

        .controls {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .products-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .products-header {
            background: #f9fafb;
            padding: 20px 25px;
            border-bottom: 1px solid #e5e7eb;
        }

        .products-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .products-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .products-list {
            padding: 25px;
        }

        .product-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.2s;
        }

        .product-card:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .product-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
        }

        .content-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .content-section {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 15px;
        }

        .content-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metafield-preview {
            background: #f8fafc;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            white-space: pre-wrap;
        }

        .original-content {
            border-left: 4px solid #3b82f6;
        }

        .french-content {
            border-left: 4px solid #10b981;
        }

        .product-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: #3b82f6;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .progress-details {
            font-size: 14px;
            color: #6b7280;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
        }

        .page-info {
            font-size: 14px;
            color: #6b7280;
            font-weight: 500;
        }

        .no-products {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .no-products h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #374151;
        }

        .no-products p {
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .content-sections {
                grid-template-columns: 1fr;
            }
            
            .product-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin-right: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Translation App</h1>
            <p>Translate product specifications to French</p>
        </div>

        <div class="controls">
            <button class="btn btn-success" onclick="translateAllToFrench()">üåç Translate All to French</button>
            <button class="btn" onclick="loadProducts()">üß™ Test Translate</button>
            <button class="btn btn-danger" onclick="stopTranslation()" id="stop-btn" style="display: none;">‚èπÔ∏è Stop Translation</button>
        </div>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-text" id="progress-text">Ready to translate...</div>
            <div class="progress-details" id="progress-details">Click "Translate All to French" to start</div>
        </div>

        <div class="products-container">
            <div class="products-header">
                <h2>Products</h2>
                <p id="products-info">Click "Test Translate" to start</p>
            </div>
            
            <div class="products-list" id="products-list">
                <div class="no-products">
                    <h3>No products loaded</h3>
                    <p>Click "Test Translate" to fetch products with specification metafields</p>
                </div>
            </div>

            <div class="pagination" id="pagination" style="display: none;">
                <button class="btn btn-secondary" onclick="loadPreviousPage()" id="prev-btn" disabled>‚Üê Previous</button>
                <span class="page-info" id="page-info">Page 1 of 1</span>
                <button class="btn btn-secondary" onclick="loadNextPage()" id="next-btn" disabled>Next ‚Üí</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentPage = 1;
        let hasNextPage = false;
        let nextPageInfo = null;
        let isTranslating = false;
        let translationController = null;

        // Get shop parameter from URL
        function getShopFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('shop');
        }

        // Load products
        async function loadProducts(page = 1) {
            const shop = getShopFromUrl();
            if (!shop) {
                alert('Shop parameter not found in URL');
                return;
            }

            try {
                showLoading();
                
                const response = await fetch(`/api/products?shop=${shop}&page=${page}&limit=20`);
                const data = await response.json();

                if (data.success) {
                    displayProducts(data.products);
                    updatePagination(data.pagination);
                    updateProductsInfo(data.products.length, data.pagination);
                } else {
                    throw new Error(data.error || 'Failed to load products');
                }
            } catch (error) {
                console.error('Error loading products:', error);
                alert('Failed to load products: ' + error.message);
                hideLoading();
            }
        }

        // Display products
        function displayProducts(products) {
            const productsList = document.getElementById('products-list');
            
            if (products.length === 0) {
                productsList.innerHTML = `
                    <div class="no-products">
                        <h3>No products found</h3>
                        <p>No products with specification metafields were found</p>
                    </div>
                `;
                return;
            }

            productsList.innerHTML = products.map(product => {
                const metafield = product.specificationMetafield;
                const metafieldId = metafield ? metafield.id : null;
                
                return `
                    <div class="product-card" data-product-id="${product.id}" data-metafield-id="${metafieldId}">
                        <div class="product-title">${product.title}</div>
                        
                        <div class="content-sections">
                            <div class="content-section">
                                <h4>Original Content</h4>
                                <div class="metafield-preview original-content" id="original-${product.id}">
                                    ${metafield ? getMetafieldPreview(metafield.value) : 'No specification metafield found'}
                                </div>
                            </div>
                            
                        <div class="content-section">
                            <h4>French Content</h4>
                            <div class="metafield-preview french-content" id="french-${product.id}">
                                Loading...
                            </div>
                        </div>
                    </div>
                    
                    <div class="product-actions">
                        ${metafield ? `
                            <button class="btn" onclick="translateToFrench('${metafieldId}', '${product.id}')">
                                üß™ Test Translate
                            </button>
                        ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Load French content for all products
            loadFrenchContentForAllProducts();
        }

        // Get metafield preview
        function getMetafieldPreview(value) {
            try {
                const parsed = JSON.parse(value);
                return JSON.stringify(parsed, null, 2).substring(0, 200) + '...';
            } catch (e) {
                return value.substring(0, 200) + '...';
            }
        }

        // Load French content for all products
        async function loadFrenchContentForAllProducts() {
            const products = document.querySelectorAll('.product-card');
            
            for (const productCard of products) {
                const metafieldId = productCard.dataset.metafieldId;
                const productId = productCard.dataset.productId;
                
                if (!metafieldId) {
                    const frenchDiv = document.getElementById(`french-${productId}`);
                    if (frenchDiv) {
                        frenchDiv.textContent = '';
                    }
                    continue;
                }

                try {
                    const response = await fetch(`/api/metafield/${metafieldId}/french?shop=${getShopFromUrl()}`);
                    const data = await response.json();
                    
                    const frenchDiv = document.getElementById(`french-${productId}`);
                    if (frenchDiv) {
                        if (data.success && data.frenchContent) {
                            try {
                                const frenchJson = typeof data.frenchContent === 'string' ? JSON.parse(data.frenchContent) : data.frenchContent;
                                frenchDiv.textContent = JSON.stringify(frenchJson, null, 2).substring(0, 200) + '...';
                            } catch (e) {
                                // If parsing fails, it might already be a string
                                const content = typeof data.frenchContent === 'string' ? data.frenchContent : JSON.stringify(data.frenchContent);
                                frenchDiv.textContent = content.substring(0, 200) + '...';
                            }
                        } else {
                            // Leave blank if no French translation
                            frenchDiv.textContent = '';
                        }
                    }
                } catch (error) {
                    console.error(`Error loading French content for product ${productId}:`, error);
                    const frenchDiv = document.getElementById(`french-${productId}`);
                    if (frenchDiv) {
                        // Leave blank on error
                        frenchDiv.textContent = '';
                    }
                }
            }
        }

        // Translate single product to French
        async function translateToFrench(metafieldId, productId) {
            const shop = getShopFromUrl();
            if (!shop) return;

            try {
                // Get the original metafield content
                const metafieldResponse = await fetch(`https://${shop}/admin/api/2023-10/metafields/${metafieldId}.json`, {
                    headers: {
                        'X-Shopify-Access-Token': '${SHOPIFY_ACCESS_TOKEN}'
                    }
                });
                
                const metafieldData = await metafieldResponse.json();
                const originalContent = JSON.parse(metafieldData.metafield.value);

                // Translate to French
                const response = await fetch(`/api/translate-to-french?shop=${shop}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        metafieldId: metafieldId,
                        content: originalContent,
                        sourceLanguage: 'en'
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert('Translation completed successfully!');
                    // Reload French content
                    loadFrenchContentForAllProducts();
                } else {
                    throw new Error(data.error || 'Translation failed');
                }
            } catch (error) {
                console.error('Error translating to French:', error);
                alert('Failed to translate: ' + error.message);
            }
        }

        // Translate all products to French
        async function translateAllToFrench() {
            const shop = getShopFromUrl();
            if (!shop) return;

            if (isTranslating) {
                alert('Translation is already in progress');
                return;
            }

            const confirmed = confirm('This will translate ALL products to French. This may take a long time. Continue?');
            if (!confirmed) return;

            isTranslating = true;
            translationController = new AbortController();
            
            showProgress();
            updateProgress(0, 'Starting bulk translation...', 'Fetching all products...');

            try {
                const response = await fetch(`/api/bulk-translate-all?shop=${shop}`, {
                    method: 'POST',
                    signal: translationController.signal
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    updateProgress(100, 'Translation completed!', `Successfully translated ${data.stats.successful} products`);
                    alert(`Bulk translation completed!\n\nSuccessfully translated: ${data.stats.successful} products\nErrors: ${data.stats.errors} products`);
                } else {
                    throw new Error(data.error || 'Bulk translation failed');
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    updateProgress(0, 'Translation stopped', 'Translation was stopped by user');
                } else {
                    console.error('Error in bulk translation:', error);
                    updateProgress(0, 'Translation failed', 'Error: ' + error.message);
                    alert('Bulk translation failed: ' + error.message);
                }
            } finally {
                isTranslating = false;
                translationController = null;
                hideProgress();
            }
        }

        // Stop translation
        function stopTranslation() {
            if (translationController) {
                translationController.abort();
                isTranslating = false;
                translationController = null;
            }
        }

        // Update pagination
        function updatePagination(pagination) {
            currentPage = pagination.currentPage;
            hasNextPage = pagination.hasNextPage;
            nextPageInfo = pagination.nextPageInfo;

            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const pageInfo = document.getElementById('page-info');
            const paginationDiv = document.getElementById('pagination');

            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = !hasNextPage;
            pageInfo.textContent = `Page ${currentPage}`;
            paginationDiv.style.display = 'flex';
        }

        // Update products info
        function updateProductsInfo(count, pagination) {
            const info = document.getElementById('products-info');
            info.textContent = `Showing ${count} products (Page ${pagination.currentPage})`;
        }

        // Load previous page
        function loadPreviousPage() {
            if (currentPage > 1) {
                loadProducts(currentPage - 1);
            }
        }

        // Load next page
        function loadNextPage() {
            if (hasNextPage) {
                loadProducts(currentPage + 1);
            }
        }

        // Show loading
        function showLoading() {
            const productsList = document.getElementById('products-list');
            productsList.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>Loading products...</div>
                </div>
            `;
        }

        // Hide loading
        function hideLoading() {
            // Loading will be replaced by displayProducts
        }

        // Show progress
        function showProgress() {
            document.getElementById('progress-container').style.display = 'block';
            document.getElementById('stop-btn').style.display = 'inline-block';
        }

        // Hide progress
        function hideProgress() {
            document.getElementById('progress-container').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'none';
        }

        // Update progress
        function updateProgress(percentage, text, details) {
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = text;
            document.getElementById('progress-details').textContent = details;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            const shop = getShopFromUrl();
            if (shop) {
                console.log('Shop detected:', shop);
            } else {
                console.log('No shop parameter found in URL');
            }
        });
    </script>
</body>
</html>